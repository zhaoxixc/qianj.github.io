<div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-01-02T09:06:11.000Z" title="2024/1/2 17:06:11">2024-01-02</time>发表</span><span class="level-item"><time dateTime="2024-01-10T07:49:33.661Z" title="2024/1/10 15:49:33">2024-01-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/qianj-work/">qianj-work</a></span><span class="level-item">1 分钟读完 (大约156个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">自动封禁多次ssh fail的IP</h1><div class="content"><!-- more -->

<p>查看ssh失败的IP和对应的次数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /var/log/secure |awk <span class="string">&#x27;/Failed/&#123;print$(NF-3)&#125;&#x27;</span>|<span class="built_in">sort</span>|<span class="built_in">uniq</span> -c</span><br></pre></td></tr></table></figure>
<p>脚本secure_ssh.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/shell/secure_ssh.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">awk <span class="string">&#x27;/Failed/&#123;print $(NF-3)&#125;&#x27;</span> /var/log/secure|<span class="built_in">sort</span>|<span class="built_in">uniq</span> -c|awk <span class="string">&#x27;&#123;print $2 &quot;=&quot; $1&#125;&#x27;</span> &gt; /etc/shell/limit_ssh.txt</span><br><span class="line">DEFINE=<span class="string">&quot;6&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">cat</span> /etc/shell/limit_ssh.txt`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"> IP=`<span class="built_in">echo</span> <span class="variable">$i</span> |awk -F= <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line"> NUM=`<span class="built_in">echo</span> <span class="variable">$i</span>|awk -F= <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`</span><br><span class="line"> <span class="keyword">if</span> [ <span class="variable">$NUM</span> -gt <span class="variable">$DEFINE</span> ]; <span class="keyword">then</span></span><br><span class="line">   grep <span class="variable">$IP</span> /etc/hosts.deny &gt; /dev/null</span><br><span class="line">   <span class="keyword">if</span> [ $? -gt 0 ]; <span class="keyword">then</span></span><br><span class="line">     <span class="built_in">echo</span> <span class="string">&quot;sshd:<span class="variable">$IP</span>:deny&quot;</span> &gt;&gt; /etc/hosts.deny</span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>赋权并写加入定时任务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x /etc/shell/secure_ssh.sh</span><br><span class="line">$ crontab -e</span><br><span class="line">*/5 * * * *  /etc/shell/secure_ssh.sh &gt; /dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<blockquote>
<p>本文来源于网络，有所改动</p>
</blockquote>
<h1 id="课程中心"><a href="#课程中心" class="headerlink" title="课程中心"></a>课程中心</h1><p><a target="_blank" rel="noopener" href="https://edu.51cto.com/lecturer/13180901.html">Qianj.51CTO</a></p>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/linux/">linux</a><a class="link-muted mr-2" rel="tag" href="/tags/%E8%84%9A%E6%9C%AC/">脚本</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/clqw6c6lx0000ooyjan81aj5i.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Centos7 Gnome桌面禁止切换用户、注销和锁屏</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/clqw3t3590000nsyj7zd73om4.html"><span class="level-item">linux下解压rar、zip、7z、tar包</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!-->